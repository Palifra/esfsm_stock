<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Inherit job form to add materials tab and buttons -->
    <record id="esfsm_job_view_form_stock" model="ir.ui.view">
        <field name="name">esfsm.job.form.stock</field>
        <field name="model">esfsm.job</field>
        <field name="inherit_id" ref="esfsm.esfsm_job_view_form"/>
        <field name="arch" type="xml">
            <!-- Add smart button for materials -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button class="oe_stat_button" type="object" name="action_view_materials"
                        icon="fa-cubes" invisible="material_count == 0">
                    <field string="Материјали" name="material_count" widget="statinfo"/>
                </button>
            </xpath>

            <!-- Add material tab in notebook (before signatures) -->
            <xpath expr="//page[@name='signatures']" position="before">
                <page string="Материјали" name="materials">
                    <!-- Hidden fields for visibility conditions -->
                    <field name="has_materials_to_take" invisible="1"/>
                    <field name="has_materials_to_consume" invisible="1"/>
                    <field name="has_materials_to_return" invisible="1"/>
                    <field name="materials_to_return_count" invisible="1"/>

                    <!-- Warning banner for unreturned materials -->
                    <div class="alert alert-warning" role="alert"
                         invisible="not has_materials_to_return">
                        <strong>⚠️ Невратени материјали!</strong>
                        Има <field name="materials_to_return_count" readonly="1" class="oe_inline"/> материјал(и) кои не се вратени.
                        Работата не може да се заврши додека материјалите не се вратат или означат како искористени.
                    </div>

                    <field name="material_ids"/>
                    <group class="oe_subtotal_footer oe_right">
                        <field name="material_total" widget="monetary"/>
                        <field name="currency_id" invisible="1"/>
                    </group>
                    <div class="oe_clear"/>

                    <!-- Material workflow buttons -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="btn-group" role="group">
                                <!-- 1. Додади - секогаш видливо -->
                                <button name="action_add_materials" string="Додади" type="object"
                                        class="btn btn-secondary" icon="fa-plus"
                                        title="Додади планирани материјали"/>

                                <!-- 2. Превземи - видливо кога има за превземање -->
                                <button name="action_take_materials" string="Превземи" type="object"
                                        class="btn btn-primary" icon="fa-download"
                                        invisible="not has_materials_to_take"
                                        title="Превземи материјали од магацин"/>

                                <!-- 3. Потроши - видливо кога има за потрошувачка -->
                                <button name="action_consume_materials" string="Потроши" type="object"
                                        class="btn btn-success" icon="fa-check"
                                        invisible="not has_materials_to_consume"
                                        title="Означи потрошени материјали"/>

                                <!-- 4. Врати - видливо кога има за враќање -->
                                <button name="action_return_materials" string="Врати" type="object"
                                        class="btn btn-warning" icon="fa-undo"
                                        invisible="not has_materials_to_return"
                                        title="Врати неискористени материјали"/>
                            </div>
                        </div>
                    </div>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Add material column in list view -->
    <record id="esfsm_job_view_tree_stock" model="ir.ui.view">
        <field name="name">esfsm.job.tree.stock</field>
        <field name="model">esfsm.job</field>
        <field name="inherit_id" ref="esfsm.esfsm_job_view_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='employee_ids']" position="after">
                <field name="material_count" string="Материјали"/>
                <field name="material_total" widget="monetary" optional="hide"/>
            </xpath>
        </field>
    </record>

    <!-- Add material search filters -->
    <record id="esfsm_job_view_search_stock" model="ir.ui.view">
        <field name="name">esfsm.job.search.stock</field>
        <field name="model">esfsm.job</field>
        <field name="inherit_id" ref="esfsm.esfsm_job_view_search"/>
        <field name="arch" type="xml">
            <xpath expr="//search" position="inside">
                <separator/>
                <filter string="Со материјали" name="has_materials"
                        domain="[('material_count', '>', 0)]"/>
                <filter string="Без материјали" name="no_materials"
                        domain="[('material_count', '=', 0)]"/>
                <filter string="Невратени материјали" name="has_materials_to_return"
                        domain="[('has_materials_to_return', '=', True)]"/>
            </xpath>
        </field>
    </record>
</odoo>
