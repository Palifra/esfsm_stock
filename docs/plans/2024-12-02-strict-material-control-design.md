# Строга контрола на материјали - Дизајн

**Датум:** 2024-12-02
**Статус:** Одобрено за имплементација

## Проблем

Моментално полињата `taken_qty`, `used_qty` и `returned_qty` може директно да се менуваат, што создава неконзистентност:
- Материјали се бележат како земени/потрошени/вратени без соодветни stock pickings
- Залихите во системот не се точни
- Нема траг за аудит

## Решение

Сите три полиња за животен циклус стануваат **readonly** и се менуваат исклучиво преку wizard-и кои креираат соодветни stock pickings.

```
planned_qty  →  taken_qty  →  used_qty  →  returned_qty
   (edit)        (readonly)    (readonly)    (readonly)
                     ↑             ↑             ↑
               "Превземи"    "Потроши"      "Врати"
                 wizard        wizard        wizard
```

## Три Wizard-и

| Wizard | Поле | Picking тип | Движење |
|--------|------|-------------|---------|
| Превземи материјали | `taken_qty` ↑ | Реверс | Магацин → Техничар |
| Потроши материјали | `used_qty` ↑ | Испратници | Техничар → Клиент |
| Врати материјали | `returned_qty` ↑ | Враќање на Реверс | Техничар → Магацин |

## Wizard: Превземи материјали

**Модел:** `esfsm.take.material.wizard`

**Функционалност:**
- Прикажува планирани материјали со достапна залиха
- Валидира дека има доволно на залиха
- Дозволува парцијално превземање ако нема доволно
- Креира Реверс picking (Магацин → Техничар)
- Ажурира `taken_qty`

**UI приказ:**
```
┌─────────────────────────────────────────────────────────────┐
│  Превземи материјали за FSM00027                            │
├─────────────────────────────────────────────────────────────┤
│  Производ              │ Планирано │ Залиха │ За превземање │
│  Кабел Cat6a           │   500 m   │ 1200 m │    500 m  ✓   │
│  Кабел RG6             │   300 m   │  150 m │    150 m  ⚠   │
│  Конектор RJ45         │    50 pc  │    0   │      -    ❌   │
├─────────────────────────────────────────────────────────────┤
│  ⚠ Предупредување за недостаток                            │
└─────────────────────────────────────────────────────────────┘
```

## Wizard: Потроши материјали

**Модел:** `esfsm.consume.material.wizard`

**Функционалност:**
- Прикажува земени материјали
- Се извршува еднаш при завршување на работата
- Валидира дека `потрошено ≤ земено - вратено`
- Креира Испратница picking (Техничар → Клиент)
- Ажурира `used_qty`

**UI приказ:**
```
┌─────────────────────────────────────────────────────────────┐
│  Потроши материјали за FSM00027                             │
├─────────────────────────────────────────────────────────────┤
│  Производ              │ Земено │ Веќе потрошено │ Потроши │
│  Кабел Cat6a           │  500 m │        0 m     │  480 m  │
│  Кабел RG6             │  150 m │        0 m     │  150 m  │
└─────────────────────────────────────────────────────────────┘
```

## Wizard: Врати материјали (постоечки)

**Модел:** `esfsm.return.material.wizard` - веќе имплементиран

Останува како што е, само полето `returned_qty` станува readonly во views.

## Работен тек

```
1. ПЛАНИРАЊЕ (при креирање на работа)
   └─► planned_qty = X

2. ПРЕВЗЕМАЊЕ (пред одење на терен)
   └─► [Превземи] wizard
       ├─► Проверка на залиха
       ├─► Реверс picking
       └─► taken_qty = Y

3. ПОТРОШУВАЧКА (при завршување)
   └─► [Потроши] wizard
       ├─► Испратница picking
       └─► used_qty = Z

4. ВРАЌАЊЕ (остаток)
   └─► [Врати] wizard
       ├─► Повратница picking
       └─► returned_qty = W

5. ЗАВРШУВАЊЕ
   └─► Валидација: taken == used + returned
       └─► Ако не е исполнето → блокирано
```

## Имплементациски задачи

| # | Задача | Фајл | Опис |
|---|--------|------|------|
| 1 | Readonly полиња | `views/esfsm_job_material_views.xml` | `taken_qty`, `used_qty`, `returned_qty` readonly |
| 2 | Превземи wizard | `wizards/esfsm_take_material_wizard.py` | Нов wizard со проверка на залиха |
| 3 | Превземи views | `wizards/wizard_views.xml` | Форма за превземање |
| 4 | Потроши wizard | `wizards/esfsm_consume_material_wizard.py` | Нов wizard |
| 5 | Потроши views | `wizards/wizard_views.xml` | Форма за потрошувачка |
| 6 | Отстрани auto-picking | `models/esfsm_job_material.py` | Отстрани `_create_*` повици од `write()` |
| 7 | Ажурирај копчиња | `views/esfsm_job_views.xml` | Три копчиња во материјали таб |
| 8 | Ажурирај __init__ | `wizards/__init__.py` | Import на нови wizard-и |
| 9 | Ажурирај manifest | `__manifest__.py` | Додај нови views |

## Безбедност

- Полињата остануваат технички едитабилни во Python (потребно за wizard-ите)
- Readonly ограничување е само во XML views
- Менаџерите може да користат shell/SQL за корекции ако е потребно

## Валидација при затворање

Веќе имплементирано во `esfsm_stock/models/esfsm_job.py`:
- `action_complete()` проверува `has_materials_to_return`
- Ако `taken_qty != used_qty + returned_qty` → ValidationError
